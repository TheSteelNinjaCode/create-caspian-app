#!/usr/bin/env node
import chalk from"chalk";import{spawn}from"child_process";import fs from"fs";import path from"path";import prompts from"prompts";const args=process.argv.slice(2),isNonInteractive=args.includes("-y"),readJsonFile=e=>{const o=fs.readFileSync(e,"utf8");return JSON.parse(o)},executeCommand=(e,o=[],n={})=>new Promise((a,t)=>{const s=spawn(e,o,{stdio:"inherit",shell:!0,...n});s.on("error",e=>{console.error(`Execution error: ${e.message}`),t(e)}),s.on("close",e=>{0===e?a():t(new Error(`Process exited with code ${e}`))})});async function getAnswer(e){const o=[{type:"toggle",name:"shouldProceed",message:`This command will update the ${chalk.blue("create-caspian-app")} package and overwrite all default files. ${chalk.blue("Do you want to proceed")}?`,initial:!1,active:"Yes",inactive:"No"}];e||o.push({type:e=>e?"text":null,name:"versionTag",message:`Enter version tag (e.g., ${chalk.cyan("latest")}, ${chalk.cyan("v4-alpha")}, ${chalk.cyan("1.2.3")}), or press Enter for ${chalk.green("latest")}:`,initial:"latest",validate:e=>!(!e||""===e.trim())||"Version tag cannot be empty"});const n=await prompts(o,{onCancel:()=>{console.warn(chalk.red("Operation cancelled by the user.")),process.exit(0)}});if(0===Object.keys(n).length)return null;let a="latest";return e?a=e:n.versionTag&&(a=n.versionTag),{shouldProceed:n.shouldProceed,versionTag:a}}const commandsToExecute={update:"npx casp update project"},parseVersionFromArgs=e=>{const o=e.find(e=>e.startsWith("@")||e.match(/^\d+\.\d+\.\d+/));if(o)return o.startsWith("@")?o.slice(1):o},main=async()=>{if(0===args.length)return console.log("No command provided."),console.log("\nUsage:"),console.log(`  ${chalk.cyan("npx casp update project")} - Update to latest version`),console.log(`  ${chalk.cyan("npx casp update project @v4-alpha")} - Update to specific tag`),console.log(`  ${chalk.cyan("npx casp update project @1.2.3")} - Update to specific version`),void console.log(`  ${chalk.cyan("npx casp update project -y")} - Update without prompts (non-interactive)`);const e=parseVersionFromArgs(args),o=`npx casp ${args.filter(e=>!e.startsWith("@")&&!e.match(/^\d+\.\d+\.\d+/)&&"-y"!==e).join(" ")}`;if(!Object.values(commandsToExecute).includes(o))return console.log("Command not recognized or not allowed."),console.log("\nAvailable commands:"),console.log(`  ${chalk.cyan("update project")} - Update project files`),void console.log(`  ${chalk.cyan("-y")} - Non-interactive mode (skip prompts)`);if(o===commandsToExecute.update)try{let o;if(isNonInteractive)o={shouldProceed:!0,versionTag:e||"latest"},console.log(chalk.blue("Running in non-interactive mode..."));else if(o=await getAnswer(e),!o?.shouldProceed)return void console.log(chalk.red("Operation cancelled by the user."));const n=process.cwd(),a=path.join(n,"caspian.config.json");if(!fs.existsSync(a))return void console.error(chalk.red("The configuration file 'caspian.config.json' was not found in the current directory."));const t=readJsonFile(a),s=o.versionTag||"latest",c=`create-caspian-app@${s}`;console.log(chalk.blue(`\nUpdating to: ${chalk.green(c)}\n`));const r=[t.projectName];t.backendOnly&&r.push("--backend-only"),t.tailwindcss&&r.push("--tailwindcss"),t.prisma&&r.push("--prisma"),t.mcp&&r.push("--mcp"),t.typescript&&r.push("--typescript"),isNonInteractive&&r.push("-y"),console.log("Executing command...\n"),await executeCommand("npx",[c,...r]),t.version=s,fs.writeFileSync(a,JSON.stringify(t,null,2)),console.log(chalk.green(`\nâœ“ Project updated successfully to version ${s}!`)),console.log(chalk.blue("Updated configuration saved to caspian.config.json"))}catch(e){e instanceof Error?e.message.includes("no such file or directory")?console.error(chalk.red("The configuration file 'caspian.config.json' was not found in the current directory.")):console.error(chalk.red(`Error during update: ${e.message}`)):console.error("Error in script execution:",e)}};main().catch(e=>{console.error("Unhandled error in main function:",e)});